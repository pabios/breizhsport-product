name: ðŸ§¹ Lint & Static Analysis

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    name: ðŸ§¼ VÃ©rification du Code
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Cloner le repo
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Installer PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql

      - name: ðŸ› ï¸ Installer les dÃ©pendances
        run: composer install --prefer-dist --no-progress

      - name: âœ… VÃ©rification avec PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=512M --level=max src/
        continue-on-error: true

      - name: âœ… VÃ©rification du formatage PHP-CS-Fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff
        continue-on-error: true

  tests:
    name: âœ… ExÃ©cuter les Tests
    runs-on: ubuntu-latest
    needs: lint  # S'assure que le lint passe avant les tests

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Cloner le repo
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Installer PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql

      - name: ðŸ› ï¸ Installer les dÃ©pendances
        run: composer install --prefer-dist --no-progress

      - name: ðŸ› ï¸ Configuration ENV pour les tests
        run: |
          cp .env.test .env
          echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db" >> .env

      - name: ðŸ—ï¸ Initialiser la base de donnÃ©es de test
        run: |
          php bin/console doctrine:database:create --env=test
          php bin/console doctrine:migrations:migrate --no-interaction --env=test
          php bin/console doctrine:fixtures:load --no-interaction --env=test

      - name: ðŸš€ Lancer les tests avec PestPHP
        run: vendor/bin/pest --coverage

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # DÃ©sactiver les clones superficiels pour une meilleure analyse

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4.1.0
        with:
          args: >
            -Dsonar.organization=pabios
            -Dsonar.projectKey=breizhsport-product
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.php.coverage.reportPaths=coverage.xml
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.branch.name=dev   # Ajout explicite de la branche
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

